(function(){this.finderGroup={};this.finderDestory=function(){for(var a in finderGroup)delete finderGroup[a]};var m=function(a,d,b){var d=d||"controller",c={},f={};f[d]=f[d]||{};f[d][b[0]]=b[1];c[a]=f;return c},l=new Class({Extends:Drag,start:function(a){this.parent(a)}});Finder=new Class({Implements:[Events],options:{selectName:"items[]"},detailStatus:{},initialize:function(a,d){$extend(this.options,d);this.id=a;this.initStaticView();this.initView();this.listContainer=this.list.getContainer();this.attachStaticEvents();
this.attachEvents();this.options.packet&&this.loadPacket()},initStaticView:function(){$each("action form filter search tip header footer pager packet".split(" "),function(a){this[a]=$("finder-"+a+"-"+this.id)},this)},initView:function(){this.list=$("finder-list-"+this.id).store("visibility",!0);this.tip=$("finder-tip-"+this.id)},isVisibile:function(){return!this.list.retrieve?!1:$chk(this.list.retrieve("visibility"))},attachStaticEvents:function(){var a=this;if(a.search){var d=a.search.getElement("input[search]").addEvent("keypress",
function(c){13===c.code&&(c.stop(),this.value.trim().length||(a.filter.value=""),c=a.form.retrieve("rowselected",[]),a.refresh(c.length&&!c.contains("_ALL_")&&!confirm(LANG_Finder.refresh_confirm)))});a.search.getElement(".finder-search-btn").addEvent("click",function(){d.fireEvent("keypress",{stop:$empty,code:13})})}a.action&&a.action.getElements("*[submit]").addEvent("click",function(c){c&&c.stop&&c.stop();var b=this.get("target"),c=this.get("submit"),d=a.form.retrieve("rowselected"),i=a.form.retrieve("_rowindex",
$H()),d="_ALL_"==d[0]?d:[];!d.length&&i&&i.getValues().sort(function(a,c){return a.toInt()-c.toInt()}).each(function(a){d.push(i.keyOf(a))});var e=new Element("form"),h=document.createDocumentFragment(),j=!1;d.each(function(c){var b=a.options.selectName;"_ALL_"==c&&(j=b="isSelectedAll");h.appendChild(new Element("input",{type:"hidden",name:b,value:c}))});e.appendChild(h);if(!e.getFirst())return MessageBox.error(LANG_Finder.error);var n=b,k={};b&&b.contains("::")&&(n=b.split("::")[0],k=JSON.decode(b.split("::")[1]),
"object"!=$type(k)&&(k={}));b=this.getProperty("confirm");if(!b||window.confirm(b))switch(j&&(b=a.form.action.match(/\?([\s\S]+$)/),b=b[1]?b[1]:"",b=[b,a.form.toQueryString(),a.filter.value].join("&"),e.adopt(b.toFormElements())),n){case "refresh":W.page(c,$extend({data:e,method:"post",onComplete:a.refresh.bind(a)},k));break;case "command":new cmdrunner(actionurl,{onSuccess:a.refresh.bind(a)});break;case "dialog":new Dialog(c,$extend({title:this.get("dialogtitle")||this.get("text"),ajaxoptions:{data:e,
method:"post"},onClose:function(){a.unselectAll();a.refresh.call(a)}},k));break;case "_blank":c=e.set({action:c,name:n,target:"_blank",method:"post"}).inject(document.body);c.submit();c.remove.delay(1E3,c);break;default:W.page(c,$extend({data:e,method:"post"},k))}});if(a.header){a.header.addEvent("click",function(c){var b=$(c.target);b.hasClass("orderable")||(b=b.getParent(".orderable"));b&&(b=["desc"==b.get("order")?"asc":"desc",b.get("key")].link({"_finder[orderType]":String.type,"_finder[orderBy]":String.type}),
a.fillForm(b).refresh(),c.stopPropagation())});var b=function(){try{a.header.setStyles({width:a.listContainer.clientWidth-a.listContainer.getPatch().x})}catch(b){}};b();LAYOUT.content_main.addEvent("resizelayout",b);a.header.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",b)})}},selectAll:function(a){this.header.getElement(".sellist")&&this.header.getElement(".sellist").set("checked",!a).fireEvent("change");a?(this.form.retrieve("rowselected").empty(),this.form.retrieve("_rowindex",
$H()).empty(),this.tip.fireEvent("_hide")):(this.form.retrieve("rowselected").empty().push("_ALL_"),this.tip.fireEvent("_update","selectedall").fireEvent("_show"))},unselectAll:function(){this.selectAll(!0)},selectFav:function(a){this.form.retrieve("rowselected").empty();this.form.retrieve("_rowindex",$H()).empty();this.list.getElements(".row .sel").each(function(d){d.hasClass("isfav")?d.set("checked",!a).fireEvent("change"):d.set("checked",!!a).fireEvent("change")})},selectunFav:function(){this.selectFav(!0)},
attachEvents:function(){var a=this,d=this.listContainer;a.list.retrieve("eventInfo",{});var b=a.form.retrieve("rowselected",[]);if(a.header&&a.list.getElement("tr")){var c=a.header.getElement(".finder-header"),f=c.getElements(".finder-col-resizer"),g=c.getElements("col"),i=c.getElement("tr").getChildren(),e=a.list.getElements("col");new l(c,{modifiers:{x:!1,y:!1},limit:{x:[35,1E3]},handle:Array.from(f),onStart:function(b,c){b.addClass("col-resizing");var f;f=c.target.getParent(".cell")?c.target.getParent(".cell").getParent("td"):
c.target.getParent("td")?c.target.getParent("td"):c.target;var e=i.indexOf(f);if(0>e)return this.cancel();f=i[e].getElement(".finder-col-resizer");b.store("_dragTargetIndex",e);g[e].addClass("resizing").setStyle("background","#e9e9e9");e=b.retrieve("_dragTargetMoveEl");e||(e=(new Element("div",{"class":"resize-move-el",styles:{height:a.header.offsetHeight+d.offsetHeight,width:f.offsetWidth,position:"absolute",top:f.getPosition().y,left:f.getPosition().x,background:"#e9e9e9",zIndex:65535,cursor:"col-resize",
opacity:0.8,borderRight:"1px #cccccc solid"}})).inject(document.body),b.store("_dragTargetMoveEl",e))},onDrag:function(a){a.retrieve("_dragTargetMoveEl",{}).setStyle("left",this.mouse.now.x)},onComplete:function(b){b.removeClass("col-resizing");var c=b.retrieve("_dragTargetIndex"),f=g[c].removeClass("resizing").setStyle("background","");if(b.retrieve("_dragTargetMoveEl")){b.retrieve("_dragTargetMoveEl").dispose();b.eliminate("_dragTargetMoveEl");var b=this.mouse.now.x-this.mouse.start.x,j=f.getStyle("width").toInt(),
b=(j+b).limit(this.options.limit.x[0],this.options.limit.x[1]),h=$$(f,e[c]),f=a.list.getElement("tr").getChildren()[c];window.webkit&&(h=$$(h,i[c],f));h.setStyle("width",b);var c=d.scrollLeft,h=d.offsetWidth,k=d.scrollWidth;0<c&&c+h>=k&&(j=b-j,0>j&&(d.scrollLeft=(d.scrollLeft-Math.abs(j)).limit(0,d.scrollWidth)));a.dropmenu&&a.dropmenu.fireEvent("position","x");f&&(j=f.get("key"),EventsRemote.post({events:m("finder_colset",a.options.object_name+"_"+a.options.finder_aliasname,[j,b])}))}}})}a.tip&&
(a.tip.addEvents({_update:function(a,b){this.retrieve("arg:class","NULL")!=a&&$$(this.childNodes).hide();var c=this.getElement("."+a);c&&(c.innerHTML=c.innerHTML.replace(/<em>([\s\S]*?)<\/em>/ig,function(){return"<em>"+b+"</em>"}),c.setStyle("display","block"));this.store("arg:class",a);this.retrieve("tipclone")||this.store("tipclone",(new Element("div",{"class":"hide",html:"&nbsp;",styles:{height:this.offsetHeight}})).injectTop(d))},_show:function(){"hidden"==this.style.visibility&&(this.setStyle("visibility",
"visible"),this.retrieve("tipclone").removeClass("hide"))},_hide:function(){"hidden"!=this.style.visibility&&(this.setStyle("visibility","hidden"),this.retrieve("tipclone").addClass("hide"))}}),c=b.length,1<c&&(c==a.tip.get("count").toInt()||b.contains("_ALL_")?a.tip.fireEvent("_update",["selectedall",c]).fireEvent("_show"):a.tip.fireEvent("_update",["selected",c]).fireEvent("_show")));a.list.addEvents({selectrow:function(a){a.getParent(".row").addClass("selected")},unselectrow:function(a){a.getParent(".row").removeClass("selected")}});
var h=a.list.getElements(".row .sel");a.rowCount=h.length;if(a.header&&a.header.getElement(".sellist"))var j=a.header.getElement(".sellist").addEvent("change",function(){h.set("checked",this.checked).fireEvent("change")});h.addEvents({click:function(){this.fireEvent("change")},focus:function(){this.blur()},change:function(){if(j){b[this.checked?"include":"erase"](this.value);var c=a.form.retrieve("_rowindex",$H());this.checked?c.set(this.value,this.get("rowindex")):c.erase(this.value)}else b.empty().push(this.value);
if(!this.checked&&b.contains("_ALL_")){b.erase("_ALL_");return a.unselectAll()}var c=b.length,d=0;if(c>1)if(c==a.tip.get("count").toInt()||b.contains("_ALL_"))a.tip.fireEvent("_update",["selectedall",c]).fireEvent("_show");else{a.tip.fireEvent("_update",["selected",c]);d=function(){$clear(d);if(!(b.length<2)){if(a.list.retrieve("eventState")=="mousedown")return d=arguments.callee.delay(200);a.tip.fireEvent("_show")}}.delay(200)}else{$clear(d);a.tip.fireEvent("_update",["selected"]).fireEvent("_hide")}a.list.fireEvent(this.checked?
"selectrow":"unselectrow",this)}});h.filter(function(a){return b&&b.push&&(b.contains(a.value)||b.contains("_ALL_"))}).set("checked",!0).fireEvent("change");(c=a.list.getElement("tr[item-id="+a.detailStatus.rowId+"]"))&&a.showDetail(c.getElement("span[detail]").get("detail"),{},c);a.list.addEvent("click",function(c){var b=$(c.target);if(b){b.match("img")&&(b=$(b.parentNode));if(b.hasClass("fav-star")){b.toggleClass("fav-star-on");c=b.getParent("tr[item-id]");c.getElement(".sel").toggleClass("isfav");
return EventsRemote.post({events:m("finder_favstar",a.options.object_name+"_"+a.options.finder_aliasname,["id-"+c.get("item-id"),b.hasClass("fav-star-on")?1:0])})}var d=b.get("detail");if(d){c.stopPropagation();return a.showDetail(d,{},b.getParent(".row"))}if(b.hasClass("cell")||b.hasClass("cell-inside"))b=b.getParent("td");if(b.match("td")&&/row/.test(b.parentNode.className)&&a.detailStatus.row)if((c=b.getParent(".row").getElement("*[detail]"))&&!b.getParent(".row").hasClass("view-detail"))return a.showDetail(c.get("detail"),
{},b.getParent(".row"))}});attachEsayCheck(a.list,"td:nth-child(first) .span-auto");var n=0,k=function(){$clear(n);n=function(){if(this.listContainer.scrollLeft!=this.header.scrollLeft){var a=this.header.scrollLeft=this.listContainer.scrollLeft,b=this.listContainer.getElement(".finder-detail-content");b&&b.setStyle("margin-left",a)}this.tip&&this.tip.style.visibility!="none"&&this.tip.setStyles({left:this.listContainer.scrollLeft,top:this.listContainer.scrollTop})}.delay(200,this)}.bind(this);k();
this.listContainer.addEvent("scroll",k);this.list.addEvent("dispose",function(){this.listContainer.removeEvent("scroll",k)}.bind(this));this.cellOpts.call(this)},fillForm:function(a){if(a&&"object"==$type(a)){var a=$H(a),d=this;a.each(function(a,c){(d.form.getElement("input[name^="+c.slice(0,-1)+"]")||(new Element("input",{type:"hidden",name:c})).inject(d.form)).set("value",a)});return d}},eraseSelected:function(){var a=this,d=a.form.retrieve("rowselected",[]);if("_ALL_"!=d[0]){var b=a.list.getElements(".row .sel");
$splat(arguments).flatten().each(function(c){var f=b.filter(function(a){return a.value==c});f.length?f.set("checked",!1).fireEvent("change"):(d.erase(c),a.tip.fireEvent("_update",["selected",d.length]))})}},eraseFormElement:function(){var a=Array.flatten(arguments),d=this;$each(a,function(a){d.form.getElement("input[name="+a+"]").remove()});return d},scrollTab:function(a,d,b){d||(d=LAYOUT.content_main);b||(b=a);var c=a.getElements("li"),f=a.getElements(".scroll-handle"),g=a.getElement(".tabs-items"),
i=2;c.each(function(a){i+=a.offsetWidth+a.getPatch("margin").x});a.getElement("ul").setStyle("width",i);var e=new Fx.Scroll(g,{link:"cancel"}),h=function(){try{var b=d.offsetWidth;a[b<i?"addClass":"removeClass"]("tabs-scroll").setStyle("width",b-2);g.setStyle("width",b-2*g.getStyle("marginLeft").toInt());e.options.duration=500;e.scrollIntoView(a.getElement(".current"))}catch(c){}};h();LAYOUT.content_main.addEvent("resizelayout",h);b.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",
h)});f.addEvents({mouseenter:function(){e.options.duration=850;e[this.hasClass("r")?"toRight":"toLeft"]()},mouseleave:function(){e.stop()}})},showDetail:function(a,d,b){var c=this,f=b.getNext(),d=b.get("item-id");this.detailCurTab&&this.detailCurTab[0]==d&&(a=this.detailCurTab[1]);if(f&&f.hasClass("finder-detail"))return this.hideDetail(b,f);this.hideDetail(this.detailStatus.row,this.detailStatus.dp);var g=new Element("tr",{"class":"finder-detail"}),i=new Element("td",{colspan:b.getElements("td").length,
"class":"finder-detail-colspan"}),e=(new Element("div",{"class":"finder-detail-content clearfix",id:"finder-detail-"+this.id})).set({container:!0});g.adopt(i.adopt(e));var h=this.list.getContainer();(f=this.detailStatus.Request)&&f.cancel();this.detailStatus.row=b.addClass("view-detail");this.detailStatus.rowId=d;this.detailStatus.Request=(new Request.HTML({evalScripts:!1,url:a+(0<a.indexOf("&")?"&":"")+"finder_name="+this.id,onRequest:function(){new MessageBox(LANG_Finder.detail.request,{type:"notice"})},
onComplete:function(a,d,f,m){g.injectAfter(b);new MessageBox(LANG_Finder.detail.complete,{autohide:1});W.render(e.set("html",f));var l=function(){try{e.setStyle("width",h.clientWidth-i.getPatch().x)}catch(a){}};l();LAYOUT.content_main.addEvent("resizelayout",l);c.list.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",l)});(a=e.getElement(".finder-tabs-wrap"))&&e.getParent(".finder-detail-colspan").addEvent("click",function(a){var b=$(a.target);"A"==b.tagName&&b.getParent(".finder-tabs-wrap")&&
(a.stop(),W.page(b.href,{update:e,onComplete:function(){c.scrollTab(e.getElement(".finder-tabs-wrap"),e,c.list)}}))});a&&c.scrollTab(a,e,c.list);$globalEval(m)}.bind(this),onFailure:function(){new MessageBox(LANG_Finder.detail.failure+[this.xhr.status],{type:"error",autohide:!0})}})).send().chain(function(){delete this.detailStatus.Request;this.detailStatus.dp=g}.bind(this))},hideDetail:function(a,d){a&&a.removeClass("view-detail");d&&d.remove();delete this.detailCurTab;delete this.detail;delete this.detailStatus.row;
delete this.detailStatus.dp;delete this.detailStatus.rowId},getFormQueryString:function(){return this.form.toQueryString()},page:function(a){this.form.store("page",a||1);this.request({method:this.form.method||"post"})},loadPacket:function(){var a=this.packet,d=this;this.options.packet&&(new Request.HTML({url:this.form.action+"&action=packet",update:a,onRequest:function(){a.addClass("loading")},onComplete:function(){a.removeClass("loading");d.scrollTab(a)}})).get()},storeTab:function(){var a=$("finder-detail-"+
this.id);if(a&&(a=a.getElement(".finder-tabs-wrap .current")))this.detailCurTab=[a.get("item-id"),a.get("url")]},refresh:function(a){this.storeTab();this.request({method:this.form.method||"post",onComplete:function(){this.loadPacket();a&&this.unselectAll()}.bind(this)})},filter2packet:function(){var a=this.filter.value;a&&new Dialog(this.form.action+"&action=filter2packet",{width:400,height:200,ajaxoptions:{method:"post",data:{filterquery:a,finder_id:this.id}}})},setCount:function(){var a=this.tip.get("count").toInt(),
d=$E(".finder-title .count");d&&d.setText(a);return this},request:function(){var a=Array.flatten(arguments).link({options:Object.type,action:String.type});a.action=a.action||this.form.action+"&page="+(this.form.retrieve("page")||1);a.options=a.options||{};var d=a.options.onComplete;"function"!=$type(d)&&(d=$empty);$extend(a.options,{clearUpdateMap:!1,updateMap:{".innerheader":this.header,".pager":this.pager},onComplete:function(){this.initView();this.setCount().attachEvents();d.apply(this,Array.flatten(arguments));
var a=$("filter-tip-"+this.id);a&&(this.filter.value.trim().length?a.setStyle("visibility","visible").highlight("#FFFFCC"):a.setStyle("visibility","hidden"))}.bind(this)});this.search&&this.search.getElement("input[search]").value.trim().length&&(this.filter.value=this.search.toQueryString());var b=this.getFormQueryString().concat("&"+this.filter.value),c=a.options.data;switch($type(c)){case "string":a.options.data=[b,c].join("&");break;case "object":case "hash":a.options.data=[b,Hash.toQueryString(c)].join("&");
break;case "element":a.options.data=[b,$(c).toQueryString()].join("&");break;default:a.options.data=b}for(v in this.detailStatus)"element"==$type(this.detailStatus[v])&&delete this.detailStatus[v];W.page(a.action,a.options)},cellOpts:function(){var a=this,d=a.list.getElements(".opt-handle");d&&d.each(function(b){a.dropmenu=new DropMenu(b,{eventType:"mouse",stopState:!0,relative:$("main"),offset:{x:0,y:0},delay:0,size:!0,onPosition:function(a){if("x"==a){var a=b.getSize().x,d=b.getParent("td"),g=d.getSize().x,
d=d.getPatch().x;this.options.offset.x=(a>g?g-d-b.getParent(".cell").getStyle("padding-right").toInt():a)-this.menu.getStyle("border-left-width").toInt()}},onHide:function(){this.element.style.position=""},onInitShow:function(){a.detailStatus.rowId&&(this.status=!0)},onShow:function(b){this.element.style.position="relative";this.bind||(b.getElements("a").addEvent("click",function(b){var c=this.get("submit")||this.get("url"),d=this.get("target");if(d&&c){b.preventDefault();var b=d.split("::")[0]||
d,e=JSON.decode(d.split("::")[1])||{};switch(b){case "dialog":var h=new Dialog(c,$extend(e,{onLoad:function(){this.dialog.getElement("form").store("target",{onComplete:function(b){h.close();if(b)a.refresh();else return MessageBox.error("REFRESH ERROR!")}})}}));break;case "tab":a.showDetail(c,e,this.getParent("tr"));break;case "request":(new Request({url:c,method:"post",data:e.data,onComplete:function(){a.showDetail(e.url,{},this.getParent("tr"))}.bind(this)})).send();break;case "confirm":if((d=this.get("confirm"))&&
!confirm(d))break;W.page(c,{onComplete:function(){a.refresh()}})}}}),this.bind=!0)}})})}});Filter=new Class({Implements:[Events,Options],options:{onPush:$empty,onRemove:$empty,onChange:$empty},initialize:function(a,d,b){this.finderId=d;this.filter=$(a);this.finderObj=window.finderGroup[d];this.setOptions(b)},update:function(){var a=this.filter,d=a.toQueryString(function(b){var c=$(b).getParent("dl"),d;if(c&&c.isDisplay()&&$(b).value)return(d=b.name.match(/_([\s\S]+)_search/))&&!a.getElement("*[name="+
d[1]+"]").value||b.name.match(/_DTYPE_TIME/)&&!a.getElement("*[name="+b.value+"]").value||(d=b.name.match(/_DTIME_\[([^\]]+)\]\[([^\]]+)\]/))&&!a.getElement("*[name="+d[2]+"]").value?void 0:!0},!0);this.finderObj.search&&(this.finderObj.search.getElement("input[search]").value="");this.finderObj.filter.value=d;d=this.finderObj.form.retrieve("rowselected",[]);d.length&&!d.contains("_ALL_")&&!confirm(LANG_Finder.refresh_confirm)?(this.finderObj.form.eliminate("rowselected"),this.finderObj.refresh(!0)):
this.finderObj.refresh();this.fireEvent("change")},retrieve:function(){var a=this.finderObj.filter.value||"";this.finderObj.search&&(this.finderObj.search.getElement("input[search]").value="");var d=this;a.replace(/([^&]+)\=([^&]+)/g,function(){var a=arguments,c=a[1],f=d.filter.getElement("[name="+c+"]");c&&(c.slice(-1)&&c.slice(-1)=="]")&&(f=d.filter.getElement("[name^="+c.substr(0,c.length-1)+"]"));if(f)f.value=decodeURIComponent(a[2])})}})})();
(function(){var m=new Tips({onShow:function(a,c){c.addClass("active");var d;a.setStyle("display","block").store("tip:imgsource",d=$pick(c.get("href"),c.get("src")));var g=a.getElement(".tip-text").set("html","&nbsp;").addClass("loading");Asset.image(d,{onload:function(){this.src==a.retrieve("tip:imgsource")&&(g.empty().adopt(this.zoomImg(g.offsetWidth,g.offsetHeight)).removeClass("loading"),this.setStyle("margin-top",(g.offsetHeight-this.height)/2))}})},text:function(){return"&nbsp;"},className:"finder-col-img-tip"}),
l=new Tips({onShow:function(a,c){c.addClass("active");a.setStyle("display","block");var d=c.retrieve("loaded:html"),g=a.getElement(".tip-text");if(d)return g.set("html",d);g.set("html","&nbsp;").addClass("loading");(new Request({url:c.get("data-load"),onSuccess:function(a){g.removeClass("loading").empty().set("html",a);c.store("loaded:html",a)}})).get()},text:function(){return"&nbsp;"},className:"finder-col-desc-tip"}),a=new Tips({onShow:function(a,c){c.addClass("active");a.setStyle("display","block")},
text:function(a){return a.get("title")||a.get("rel")},className:"finder-col-text-tip"}),d=new Tips({onShow:function(a,c){c.addClass("active");a.setStyle("display","block")},text:function(a){return a.getElement("textarea").value},className:"finder-col-desc-tip"});this.bindFinderColTip=function(b){var b=new Event(b),c=b.target;c&&(c.onmouseover=null,c.hasClass("img-tip")?m.attach(c):c.hasClass("desc-tip")?d.attach(c):c.hasClass("load-tip")?l.attach(c):a.attach(c),c.addEvent("mouseleave",function(){this.removeClass("active")}),
c.fireEvent("mouseenter",b))}})();